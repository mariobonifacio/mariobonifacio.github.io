---
title: "R Notebook"
output: html_notebook
---


```{r setup}
library(tidyverse); library(lubridate); library(ggalluvial); library(ggthemes); library(nycflights13)
```




```{r}
## Load csv files
flights_17 <- read_csv2(file = 'flights_17.csv', na = 'NULL', trim_ws = T)
# airlines_17 <- read_csv(file = 'airlines_17.csv', trim_ws = T)
# airports_17 <- read_csv(file = 'airports_17.csv', trim_ws = T, col_names = c('airport_name', 'airport_iata', 'airport_st'))
```


```{r}
## Make metric hour function
metric_time <- function(horhm, mm = rep(-1, length(horhm))){
  if(mm < 0){
    return(trunc(horhm/100) + (horhm/100 - trunc(horhm/100)) * 5 / 3)
  }
  else{
    return(horhm + mm/60)
  }
}

```


```{r}
## Make metric month function
metric_month <- function(mo, mo_day){
  return(mo + (mo_day - 0.5) / max(mo_day))
}
```


```{r}
## This function accepts a single-column tibble,
## and an equal-length tibble then finds correlation
## between the dependent variable and each independent
## variables

hi_cor <- function(y, test_tibble){  
  cbind(y, test_tibble) %>%
  cor(use = 'pairwise.complete.obs') %>%
  as.data.frame(row.names = colnames(.)) %>%
  select(1) %>%
  filter(.[1] < 1) %>%
  arrange()
}

```


```{r}
## build a test set 
test_17 <- flights_17 %>%
  filter(!is.na(dep_delay)) %>% ## Remove flights that are missing dep_delay
  mutate(is_delay = dep_delay > 0, ## Simplified binary, knowing that logical coerces to numeric as 1 or 0
         diff_531mo = abs(5.31 - month), 
         wkday = weekdays(time_hour)) %>% ## Alternately, I could use wday to get the day number, but get better results with categorical variables
  group_by(month) %>%
  mutate(month_metric = metric_month(month, day),
         q90_month = quantile(dep_delay, probs = 0.9, na.rm = T),
         time_metric = hour + (minute + .5) / 60,
         diff_21h = abs(21 - time_metric)) %>%
  ungroup() %>%
  group_by(time_metric) %>%
  mutate(q90_time = quantile(dep_delay, probs = 0.9, na.rm = T)) %>%
  ungroup()

test_17 %>%
  select(diff_21h,time_metric, q90_time) %>%
  unique() %>%
  ggplot() +
  geom_point(mapping = aes(time_metric, q90_time, color = 'time'), size = 1) +
  geom_smooth(aes(time_metric, q90_time, color = 'time'), method = 'loess') +
  geom_point(mapping = aes(diff_21h, q90_time, color = 'adj_time'), size = 1) +
  geom_smooth(aes(diff_21h, q90_time, color = 'adj_time'), method = 'loess') +
  theme_fivethirtyeight() +
  scale_color_fivethirtyeight()

######         
```

```{r}
## Test month ##

cor_df <- tibble(i = 1L, cor_i = 0.001)

for(i in 101:1231) {
  cor_df[i, 1] <- i/100
  cor_df[i, 2] <- cor(abs(i/100 - test_17$month), test_17$q90_month)
}

cor_df %>%
  arrange(desc(abs(cor_i)))

```

```{r}
## Test time ##

cor_df <- tibble(i = 1L, cor_i = 0.001)

for(i in 900:2300) {
  cor_df[i, 1] <- i/100
  cor_df[i, 2] <- cor(abs(i/100 - test_17$time_metric), test_17$q90_time)
}

cor_df %>%
  arrange(desc(abs(cor_i)))

```



```{r}
mdl <- test_17 %>%
  glm(formula = dep_delay ~ diff_531mo + diff_21h + wkday, family = 'gaussian') %>%
  summary()

mdl_df <- mdl$coefficients %>%
  as_tibble() %>%
  mutate(x_value = row.names(mdl$coefficients)) %>%
  select(x_value, est_coeff = 1, se = 2) %>%
  mutate(coeff_90 = est_coeff + 1.28 * se,
         y_form = case_when(row_number() == 1 ~ as.character(est_coeff),
                             row_number() %in% 2:(length(est_coeff) - 1) ~
                               paste(est_coeff,'*', x_value, '+'),
                             row_number() == length(est_coeff) ~
                               paste(est_coeff,'*', x_value)))

paste(mdl_df[[5]])
```


```{r}  
test_17 %>%
  group_by(wkday, month_metric, time_metric) %>%
  summarize(q90_all = quantile(dep_delay, probs = 0.9),
            wkend = max(!(wkday %in% c('Friday', 'Saturday', 'Sunday')))) %>%
  ggplot() +
  geom_point(mapping = aes(time_metric, q90_all,
                            color = wkend,
                            alpha = !wkend)) +
  jitter(time_metric)
  

```


```{r}
## Model ##
test_17 %>%
  glm(formula = is_delay ~ distance, family = 'binomial') %>%
  summary()

```


```{r}
names(test_17)
```


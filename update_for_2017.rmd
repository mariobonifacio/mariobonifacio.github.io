---
title: "R Notebook"
output: html_notebook
---


```{r setup}
knitr::opts_chunk$set(message = FALSE)
library(tidyverse); library(lubridate); library(ggalluvial); library(ggthemes); library(nycflights13)
```




```{r, echo=FALSE, message=FALSE}
## Load csv files from mariobonifacio.github.io
flights_17 <- read_csv2(file = 'flights_17.csv', na = 'NULL', trim_ws = T)
# airlines_17 <- read_csv(file = 'airlines_17.csv', trim_ws = T)
# airports_17 <- read_csv(file = 'airports_17.csv', trim_ws = T, col_names = c('airport_name', 'airport_iata', 'airport_st'))
```


```{r}
## Make metric hour function
metric_time <- function(horhm, mm = rep(-1, length(horhm))){
  if(mm < 0){
    return(trunc(horhm/100) + (horhm/100 - trunc(horhm/100)) * 5 / 3)
  }
  else{
    return(horhm + mm/60)
  }
}

```


```{r}
## Make metric month function
metric_month <- function(mo, mo_day){
  return(mo + (mo_day - 0.5) / max(mo_day))
}
```


```{r}
## This function accepts a single-column tibble,
## and an equal-length tibble then finds correlation
## between the dependent variable and each independent
## variables

hi_cor <- function(y, test_tibble){  
  cbind(y, test_tibble) %>%
  cor(use = 'pairwise.complete.obs') %>%
  as.data.frame(row.names = colnames(.)) %>%
  select(1) %>%
  filter(.[1] < 1) %>%
  arrange()
}

```


```{r, message=FALSE}
## build a test set 
test_17 <- flights_17 %>%
  filter(!is.na(dep_delay)) %>% ## Remove flights that are missing dep_delay
  group_by(month) %>%
  mutate(is_delay = dep_delay > 0,
         diff_531mo = abs(5.31 - month),
         wkday = weekdays(time_hour),
         month_metric = metric_month(month, day),  ## Using my function
         time_metric = metric_time(sched_dep_time), ## Using my function
         diff_21h = abs(21 - time_metric)) %>%
  ungroup() %>%
  group_by(month_metric, time_metric) %>%
  mutate()
```



```{r}

lm_formula <- function(my_df, )

mdl <- test_17 %>%
  lm(formula = dep_delay ~ diff_531mo + diff_21h + wkday) %>%
  summary()

mdl_df <- mdl$coefficients %>%
  as_tibble() %>%
  mutate(x_value = row.names(mdl$coefficients),
         q90_pred = 1) %>%
  select(x_value, 1, 2)
  

  

```


```{r}
test_17 %>%
  group_by(week(time_hour)) %>%
  mutate(quantile_90 = quantile(dep_delay, probs = 0.9),
         wk = week(time_hour)) %>%
  ungroup() %>%
  ggplot() +
  geom_point(mapping = aes(wk, quantile_90)) +
  geom_smooth(mapping = aes(wk, quantile_90, color = wkday))
  
```



```{r}
## Test month ##

cor_df <- tibble(i = 1L, cor_i = 0.001)

for(i in 101:1231) {
  cor_df[i, 1] <- i/100
  cor_df[i, 2] <- cor(abs(i/100 - test_17$month), test_17$q90_month)
}

cor_df %>%
  arrange(desc(abs(cor_i)))

```


```{r}
## Test time ##

cor_df <- tibble(i = 1L, cor_i = 0.001)

for(i in 900:2300) {
  cor_df[i, 1] <- i/100
  cor_df[i, 2] <- cor(abs(i/100 - test_17$time_metric), test_17$q90_time)
}

cor_df %>%
  arrange(desc(abs(cor_i)))

```


```{r, message=FALSE}
## With this plot, I wanted to show why I chose to use a difference factor
## rather than just using the time of day variable. Intuitively, the
## reason is that 

test_17 %>%
  select(diff_21h,time_metric, q90_time) %>%
  unique() %>%
  ggplot() +
  geom_point(mapping = aes(time_metric, q90_time, color = 'time'), size = 1) +
  geom_smooth(aes(time_metric, q90_time, color = 'time'), method = 'loess') +
  geom_point(mapping = aes(diff_21h, q90_time, color = 'adj_time'), size = 1) +
  geom_smooth(aes(diff_21h, q90_time, color = 'adj_time'), method = 'loess') +
  theme_fivethirtyeight() +
  scale_color_fivethirtyeight()
```

---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

Loading packages
```{r message=FALSE, warning=FALSE, include=FALSE}


library(lubridate)
library(data.table)
library(tidyverse)
library(dplyr)
library(jsonlite)
library(ggrepel)
library(stringr)
```


Pulling the most recent data from covidtracking.com...
```{r include=FALSE}
all_data <- "https://covidtracking.com/api/v1/states/daily.json" %>%
  fromJSON() %>%
  as.data.table()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
print(str_c("As of ", Sys.time()))
```



Narrowing data...
```{r include=FALSE}
my_data <- all_data %>% 
  mutate(as_of = ymd(date),
         tests = positive + negative,
         test_ch = positiveIncrease + negativeIncrease) %>% 
  select(as_of,
         code = state,
         cases = positive,
         case_ch = positiveIncrease,
         death,
         death_ch = deathIncrease,
         tests,
         test_ch) %>% 
  data.table()

```



Adding state population data...
```{r include=FALSE}
st_pop_2019 <- read_csv("st_pop.csv") %>% 
  select(name = 5, pop_2019 = 17) %>% 
  mutate(pop_2019 = as.integer(pop_2019))
```



Building tables...
```{r include=FALSE}
code_names <- data.table(cbind(name = state.name,
                 code = state.abb,
                 region = as.character(state.region),
                 reg_2 = c("South", "Plains and Mountains", "Southwest", "Middle South", "West Coast",
                           "Southwest", "Northeast", "Northeast", "South", "South",
                           
                           "West Coast", "Plains and Mountains", "Midwest", "Midwest", "Midwest",
                           "Plains and Mountains", "Middle South", "South", "Northeast", "Northeast",
                           
                           "Northeast", "Midwest", "Midwest", "South", "Midwest",
                           "Plains and Mountains", "Plains and Mountains", "Southwest", "Northeast", "Northeast",
                           
                           "Southwest", "Northeast", "South", "Plains and Mountains", "Midwest",
                           "Plains and Mountains", "West Coast", "Northeast", "Northeast", "South",
                           
                           "Plains and Mountains", "Middle South", "South", "Plains and Mountains", "Northeast",
                           "South", "West Coast", "Middle South", "Midwest", "Plains and Mountains")))
```





```{r include=FALSE}
test_growth <- code_names %>% 
  inner_join(st_pop_2019) %>% 
  inner_join(my_data) %>% 
  group_by(code) %>% 
  filter(as_of > as_date(ymd_hms(now())) - 7) %>%
  summarize(test_weekly_growth = round((max(tests) - min(tests)) / min(tests), 2),
            tests_weekly_per_mil = signif(((max(tests) - min(tests)) / mean(pop_2019) * 1000000), 3),
            wk_ending = max(as_of)) %>% 
  arrange(desc(test_weekly_growth))
```

```{r include=FALSE}
death_growth <- code_names %>% 
  inner_join(st_pop_2019) %>% 
  inner_join(my_data) %>% 
  group_by(code) %>% 
  filter(as_of > as_date(ymd_hms(now())) - 14) %>%
  summarize(death_weekly_growth = round(((max(death) - min(death)) / min(death)) ^ 0.5, 2), death_weekly_per_mil = signif(sum(death_ch) / mean(pop_2019) * 1000000 / 2, 3), wk_ending = max(as_of)) %>% 
  arrange(desc(death_weekly_growth))
```

```{r include=FALSE}
case_growth <- code_names %>% 
  inner_join(st_pop_2019) %>% 
  inner_join(my_data) %>% 
  group_by(code) %>% 
  filter(as_of > as_date(ymd_hms(now())) - 14) %>%
  summarize(cases_weekly_growth = round(((max(cases) - min(cases)) / min(cases)) ^ 0.5, 2), cases_weekly_per_mil = signif(((max(cases) - min(cases)) / mean(pop_2019) * 1000000 / 2), 3), wk_ending = max(as_of)) %>% 
  arrange(desc(cases_weekly_growth))
```
done



```{r echo=FALSE, message=FALSE, warning=FALSE}
test_growth %>%
  inner_join(code_names, by = "code") %>%
  inner_join(case_growth, by = "code") %>% 
  arrange(desc(tests_weekly_per_mil)) %>% 
  filter((tests_weekly_per_mil < quantile(test_growth$tests_weekly_per_mil, probs = 0.2)) | (tests_weekly_per_mil > quantile(test_growth$tests_weekly_per_mil, probs = 0.7))) %>% 
  ggplot() +
  geom_col(mapping = aes(x = reorder(x = code, X = tests_weekly_per_mil), y = tests_weekly_per_mil, fill = reg_2)) +
  labs(x = "state", y = "Weekly tests per million residents", title = stringr::str_c("States with the fewest and most tests per million"), subtitle = str_c("week ending", death_growth$wk_ending[1], sep = " "))
```


```{r echo=FALSE}
test_growth %>%
  inner_join(code_names, by = "code") %>%
  inner_join(death_growth, by = "code") %>% 
  arrange(desc(tests_weekly_per_mil)) %>% 
  # filter(tests_weekly_per_mil < quantile(test_growth$tests_weekly_per_mil, probs = 0.5)) %>% 
  ggplot(mapping = aes(x = death_weekly_growth, y = tests_weekly_per_mil, label = code, fill = reg_2)) +
  geom_label_repel() +
  labs(x = "Growth in weekly deaths", y = "Weekly tests per million residents", title = stringr::str_c("State tests and weekly growth in deaths"), subtitle = str_c("week ending", death_growth$wk_ending[1], sep = " "))
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
case_growth %>%
  inner_join(code_names) %>% 
  arrange(desc(cases_weekly_per_mil)) %>% 
  filter(cases_weekly_per_mil > quantile(case_growth$cases_weekly_per_mil, probs = 0.7)) %>% 
  ggplot() +
  geom_col(mapping = aes(x = reorder(code, X = desc(cases_weekly_per_mil)), y = cases_weekly_per_mil, fill = reg_2)) +
  labs(x = "state", y = "Weekly cases per million residents", title = stringr::str_c("States with most new cases per million"), subtitle = str_c("2 weeks ending", case_growth$wk_ending[1], sep = " "))
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
case_growth %>%
  inner_join(code_names) %>% 
  arrange(desc(cases_weekly_growth)) %>% 
  filter(cases_weekly_growth > quantile(case_growth$cases_weekly_growth, probs = 0.7)) %>% 
  ggplot() +
  geom_col(mapping = aes(x = reorder(code, X = desc(cases_weekly_growth)), y = cases_weekly_growth, fill = reg_2)) +
  labs(x = "state", y = "weekly case growth rate", title = stringr::str_c("Highest case growth rate by state, week ending", case_growth$wk_ending[1], sep = " "))
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
death_growth %>%
  inner_join(code_names) %>% 
  ggplot(mapping = aes(x = death_weekly_growth, y = death_weekly_per_mil, color = reg_2)) +
  ## geom_point() +
  ggrepel::geom_text_repel(mapping = aes(label = code)) +
  labs(x = "Weekly death growth rate", y = "Weekly deaths per million", title = "Deaths over the past week per million and growth in deaths",
       subtitle = "States having a hard time now and those who may face hard times soon")
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
case_growth %>%
  inner_join(code_names) %>% 
  ggplot(mapping = aes(x = cases_weekly_growth, y = cases_weekly_per_mil, color = reg_2)) +
  ## geom_point() +
  ggrepel::geom_text_repel(mapping = aes(label = code)) +
  labs(x = "Weekly case growth rate", y = "Weekly new cases per million", title = "Cases over the past week per million and growth in cases",
       subtitle = "Shows states having a hard time now and those who may face hard times soon")
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
pk <- c("TX")


my_data %>% 
  filter(code %in% pk) %>%
    mutate(death_ch = if_else(as_of == ymd("2020-04-30") & code == "TX", 50, as.double(death_ch))) %>% 
  group_by(as_of) %>%
  summarize(us_cases = sum(cases, na.rm = TRUE),
            us_cases_ch = sum(case_ch, na.rm = TRUE),
            us_deaths = sum(death, na.rm = TRUE),
            us_deaths_ch = sum(death_ch, na.rm = TRUE)) %>% 
  filter(us_deaths > 9) %>% 
  mutate(since = min(as_of),
         is_day = if_else(weekdays(as_of) == weekdays(my_data[[1,1]]), 0.3, 0.1)) %>% 
  ggplot(mapping = aes(x = as_of, y = us_deaths_ch)) +
  geom_smooth(linetype = 0, mapping = aes(fill = weekdays(as_of), alpha = is_day)) +
  geom_smooth(size = 1, alpha = 0, linetype = 2, color = "black") +
  theme(legend.position = "none") +
  labs(title = str_c("Are", pk, "deaths plateauing or even dropping?", sep = " "), subtitle = str_c("Deaths per day since", min(my_data[code %in% pk, as_of]), sep = " "), x = "date", y = "COVID-19 daily deaths") +
  scale_alpha(range = c(.1, .3))
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
pk <- c("TX")

my_data %>% 
  filter(code %in% pk) %>%
  group_by(as_of) %>%
  summarize(us_cases = sum(cases, na.rm = TRUE),
            us_cases_ch = sum(case_ch, na.rm = TRUE),
            us_deaths = sum(death, na.rm = TRUE),
            us_deaths_ch = sum(death_ch, na.rm = TRUE)) %>% 
  filter(us_deaths > 9) %>% 
  ggplot(mapping = aes(x = as_of, y = us_cases_ch)) +
  geom_smooth(linetype = 0, mapping = aes(fill = weekdays(as_of)), alpha = 0.1) +
  geom_smooth(size = 1, alpha = 0, linetype = 2, color = "black") +
  theme(legend.position = "none") +
  labs(title = str_c("Are new", pk,"cases plateauing or even dropping?", sep = " "), subtitle = "New cases per day since mid-March", x = "date", y = "New COVID-19 cases per day")
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
pk <- c("NY")

my_data %>% 
  filter(code != pk) %>% 
  group_by(as_of) %>%
  summarize(us_cases = sum(cases, na.rm = TRUE),
            us_cases_ch = sum(case_ch, na.rm = TRUE),
            us_deaths = sum(death, na.rm = TRUE),
            us_deaths_ch = sum(death_ch, na.rm = TRUE)) %>% 
  filter(us_cases > 99) %>%
  mutate(since = min(as_of)) %>% 
  ggplot(mapping = aes(x = as_of, y = us_deaths_ch)) +
  geom_smooth(linetype = "dashed") +
  geom_line(size = 1) +
  labs(title = str_c("Are non-", pk, " deaths plateauing or even dropping?", sep = ""), subtitle = "U.S. deaths since the 100th case", x = "date", y = "COVID-19 deaths")
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
pk <- c("NY", "NJ", "MA", "MI", "CT", "RI")

my_data %>% 
  filter(!(code %in% (pk))) %>% 
  group_by(as_of) %>%
  summarize(us_cases = sum(cases, na.rm = TRUE),
            us_cases_ch = sum(case_ch, na.rm = TRUE),
            us_deaths = sum(death, na.rm = TRUE),
            us_deaths_ch = sum(death_ch, na.rm = TRUE)) %>% 
  filter(us_cases > 99) %>%
  mutate(since = min(as_of)) %>% 
  ggplot(mapping = aes(x = as_of, y = us_cases_ch)) +
  geom_smooth(linetype = 0, alpha = .2, mapping = aes(fill = weekdays(as_of))) +
  geom_smooth(alpha = 0, size = 1, linetype = 2, color = "black") +
  theme(legend.position = "none") +
  labs(title = str_c("Are non-", str_c(pk, collapse = ", "), " cases plateauing or even dropping?", sep = ""), subtitle = "U.S. cases since the 100th case", x = "date", y = "COVID-19 new cases")
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
top_n(death_growth, n = 20) %>%
  inner_join(top_n(case_growth, n = 20)) %>%
  inner_join(code_names) %>% 
  filter((death_weekly_per_mil > as.numeric(reorder(death_growth$death_weekly_per_mil, desc(death_growth$death_weekly_per_mil))[[11]])) |
           (cases_weekly_per_mil > as.numeric(reorder(case_growth$cases_weekly_per_mil, desc(case_growth$cases_weekly_per_mil))[[11]]))) %>% 
  ggplot(mapping = aes(x = death_weekly_per_mil, y = cases_weekly_per_mil)) +
  geom_smooth(method = "lm", mapping = aes(color = NULL), linetype = "dotted", fill = 0.1, color = "lightgray") +
  ## geom_point(mapping = aes(color = reg_2), size = 2) +
  ggrepel::geom_text_repel(mapping = aes(label = code, color = reg_2)) +
  labs(x = "Weekly deaths per million", y = "Weekly new cases per million", title = "States dealing with a lot right now", subtitle = str_c("As of ", death_growth[[1, "wk_ending"]]))
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
death_growth %>%
  inner_join(case_growth) %>%
  inner_join(code_names) %>% 
  filter((death_weekly_growth > death_growth$death_weekly_growth[20]) |
           (cases_weekly_growth > case_growth$cases_weekly_growth[20])) %>% 
  ggplot(mapping = aes(x = death_weekly_growth, y = cases_weekly_growth, color = reg_2)) +
  ggrepel::geom_text_repel(mapping = aes(label = code)) +
  labs(x = "Weekly growth in deaths", y = "Weekly growth in cases", title = "States where deaths or new cases are rising", subtitle = str_c("As of ", death_growth[[1, "wk_ending"]]))
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
top_n(death_growth, n = 20) %>%
  inner_join(top_n(case_growth, n = 20)) %>%
  inner_join(code_names) %>% 
  filter((death_weekly_per_mil > as.numeric(reorder(death_growth$death_weekly_per_mil, desc(death_growth$death_weekly_per_mil))[[11]])) |
           (cases_weekly_per_mil > as.numeric(reorder(case_growth$cases_weekly_per_mil, desc(case_growth$cases_weekly_per_mil))[[11]]))) %>% 
  ggplot(mapping = aes(x = death_weekly_per_mil, y = cases_weekly_per_mil)) +
  geom_smooth(method = "lm", mapping = aes(color = NULL), linetype = "dotted", fill = 0.1, color = "lightgray") +
  ## geom_point(mapping = aes(color = reg_2), size = 2) +
  ggrepel::geom_text_repel(mapping = aes(label = code, color = reg_2)) +
  labs(x = "Weekly deaths per million", y = "Weekly new cases per million", title = "States dealing with a lot right now")
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
since_100 <- my_data %>% 
  arrange(code, as_of) %>% 
  inner_join(code_names) %>% 
  inner_join(st_pop_2019) %>% 
  mutate(cases_pm = cases / pop_2019 * 1E6,
         deaths_pm = death / pop_2019 * 1E6) %>% 
  filter(cases_pm >= 100) %>% 
  group_by(code) %>% 
  mutate(days_in = as.integer(as_of - min(as_of))) %>% 
  ungroup()
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
since_100_labels <- since_100 %>% 
  group_by(code) %>% 
  summarize(lab_days = max(days_in), lab_deaths = max(deaths_pm))

test_code <- c("GA", "WA", "TX", "AR", "CA", "FL", "OK", "MN", "MS")

since_100 %>%
  filter(code %in% test_code) %>%
  inner_join(since_100_labels) %>%
  group_by(code) %>% 
  mutate(lab_days = if_else(lab_days == days_in, lab_days, NULL),
         lab_deaths = if_else(lab_deaths == deaths_pm, lab_deaths, NULL)) %>%
  ggplot(mapping = aes(color = code, x = days_in, y = deaths_pm)) +
  geom_line() +
  geom_label_repel(aes(x = lab_days, y = lab_deaths, label = code), na.rm = TRUE) +
  labs(x = "Days since a state identified COVID-19 in 0.01% of its residents",
       y = "Cumulative deaths per million residents",
       title = "Allows for comparison between states on different timelines")
  

```



```{r echo=FALSE, message=FALSE, warning=FALSE}
since_100 %>% 
  inner_join(since_100_labels) %>% 
  mutate(cfr = death / cases,
         tests_pm = tests / pop_2019 * 1E6) %>% 
  filter(days_in == 21) %>% 
  ggplot(mapping = aes(x = tests_pm, y = cfr, label = code)) +
  geom_smooth(method = "lm") +
  geom_text_repel(mapping = aes(color = reg_2)) +
  labs(x = "Coronavirus tests per million residents", y = "Case fatality ratio", title = "Testing more is associated with a lower case fatality rate")
  
```

```{r}

```


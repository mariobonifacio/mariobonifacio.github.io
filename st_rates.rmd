---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

Loading packages
```{r message=FALSE, warning=FALSE, include=FALSE}


library(lubridate)
library(data.table)
library(tidyr)
library(magrittr)
library(ggplot2)
library(dplyr)
library(jsonlite)
library(ggrepel)
library(stringr)
library(readr)


```


Pulling the most recent data from covidtracking.com...
```{r include=FALSE}
all_data <- "https://covidtracking.com/api/v1/states/daily.json" %>%
  fromJSON() %>%
  as.data.table()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
print(str_c("As of ", Sys.time()))
```



Narrowing data...
```{r include=FALSE}
my_data <- all_data %>% 
  mutate(as_of = ymd(date),
         tests = positive + negative,
         test_ch = positiveIncrease + negativeIncrease) %>% 
  select(as_of,
         code = state,
         cases = positive,
         case_ch = positiveIncrease,
         death,
         death_ch = deathIncrease,
         tests,
         test_ch) %>% 
  data.table()

```



Adding state population data...
```{r include=FALSE}
st_pop_2019 <- read_csv("st_pop.csv") %>% 
  select(name = 5, pop_2019 = 17) %>% 
  mutate(pop_2019 = as.integer(pop_2019))
```



Building tables...
```{r include=FALSE}
code_names <- data.table(cbind(name = state.name,
                 code = state.abb,
                 region = as.character(state.region),
                 reg_2 = c("South", "Plain and Mountain", "Southwest", "Middle South", "West Coast",
                           "Southwest", "Northeast", "Northeast", "South", "South",
                           
                           "West Coast", "Plain and Mountain", "Midwest", "Midwest", "Midwest",
                           "Plain and Mountain", "Middle South", "South", "Northeast", "Northeast",
                           
                           "Northeast", "Midwest", "Midwest", "South", "Midwest",
                           "Plain and Mountain", "Plain and Mountain", "Southwest", "Northeast", "Northeast",
                           
                           "Southwest", "Northeast", "South", "Plain and Mountain", "Midwest",
                           "Plain and Mountain", "West Coast", "Northeast", "Northeast", "South",
                           
                           "Plain and Mountain", "Middle South", "Southwest", "Plain and Mountain", "Northeast",
                           "South", "West Coast", "Middle South", "Midwest", "Plain and Mountain")))
```


```{r include=FALSE}
test_growth <- code_names %>% 
  inner_join(st_pop_2019) %>% 
  inner_join(my_data) %>% 
  group_by(code) %>% 
  filter(as_of > as_date(ymd_hms(now())) - 7) %>%
  summarize(test_weekly_growth = round((max(tests) - min(tests)) / min(tests), 2),
            tests_weekly_per_mil = signif(((max(tests) - min(tests)) / mean(pop_2019) * 1000000), 3),
            wk_ending = max(as_of)) %>% 
  arrange(desc(test_weekly_growth))
```

```{r include=FALSE}
death_growth <- code_names %>% 
  inner_join(st_pop_2019) %>% 
  inner_join(my_data) %>% 
  group_by(code) %>% 
  filter(as_of > as_date(ymd_hms(now())) - 7) %>%
  summarize(death_weekly_growth = round((max(death) - min(death)) / min(death), 2), death_weekly_per_mil = signif(sum(death_ch) / mean(pop_2019) * 1000000 / 2, 3), wk_ending = max(as_of)) %>% 
  arrange(desc(death_weekly_growth))
```


```{r include=FALSE}
weekly_data <- code_names %>% 
  inner_join(st_pop_2019) %>% 
  inner_join(my_data) %>% 
  mutate(week_num = lubridate::week(as_of)) %>% 
  group_by(code, week_num) %>%
  mutate(weekly_cases = sum(case_ch),
         weekly_deaths = sum(death_ch),
         weekly_tests = sum(test_ch))
  
```


```{r include=FALSE}
case_growth <- code_names %>% 
  inner_join(st_pop_2019) %>% 
  inner_join(my_data) %>% 
  group_by(code) %>% 
  filter(as_of > as_date(ymd_hms(now())) - 7) %>%
  summarize(cases_weekly_growth = round((max(cases) - min(cases)) / min(cases), 2), cases_weekly_per_mil = signif(((max(cases) - min(cases)) / mean(pop_2019) * 1000000 / 2), 3), wk_ending = max(as_of)) %>% 
  arrange(desc(cases_weekly_growth))
```
done



```{r echo=FALSE, message=FALSE, warning=FALSE}
test_growth %>%
  inner_join(code_names, by = "code") %>%
  inner_join(case_growth, by = "code") %>% 
  arrange(desc(tests_weekly_per_mil)) %>% 
  filter((tests_weekly_per_mil < quantile(test_growth$tests_weekly_per_mil, probs = 0.2)) | (tests_weekly_per_mil > quantile(test_growth$tests_weekly_per_mil, probs = 0.8))) %>% 
  ggplot() +
  geom_col(mapping = aes(x = reorder(x = code, X = tests_weekly_per_mil), y = tests_weekly_per_mil, fill = reg_2)) +
  labs(x = "state", y = "Weekly tests per million residents", title = stringr::str_c("States with the fewest and most tests per million"), subtitle = str_c("week ending", death_growth$wk_ending[1], sep = " ")) +
  theme(legend.title=element_blank())
```


Tests & cases
```{r warning=FALSE}
my_data %>% 
  inner_join(code_names, by = "code") %>% 
  inner_join(st_pop_2019, by = "name") %>%
  filter(as_of >= Sys.Date() - months(2)) %>% 
  mutate(week_num = lubridate::week(as_of)) %>% 
  group_by(week_num, reg_2) %>%
  summarize(as_of = median(as_of), pos_rate = sum(case_ch) / sum(test_ch)) %>% 
  ggplot(mapping = aes(x = as_of, y = pos_rate, color = reg_2, fill = reg_2)) +
  geom_smooth(alpha = .1, span = .5) +
  labs(x = "Date", y = "Share of COVID-19 tests with positive results", title = "Positive rates are increasing in the South and Southwest", subtitle = str_c("As of ", max(my_data$as_of))) +
  theme(legend.title = element_blank())
```



Tests & cases
```{r warning=FALSE}
my_data %>% 
  inner_join(code_names, by = "code") %>% 
  inner_join(st_pop_2019, by = "name") %>%
  filter(as_of >= Sys.Date() - months(1)) %>% 
  mutate(week_num = lubridate::week(as_of)) %>% 
  group_by(week_num, code) %>%
  summarize(pos_rate = sum(case_ch) / sum(test_ch),
            as_of = median(as_of)) %>% 
  group_by(code) %>% 
  mutate(y_label = if_else(as_of == median(as_of, na.rm = TRUE), median(pos_rate, na.rm = TRUE), NULL),
         month_pos = mean(pos_rate, na.rm = TRUE),
         ) %>% 
  ggplot(mapping = aes(x = as_of, y = pos_rate)) +
  geom_smooth(alpha = 0, span = .6) +
  geom_label(mapping = aes(y = y_label, label = code), na.rm = TRUE) +
  labs(x = "Date", y = "Share of COVID-19 tests with positive results", title = "Positive rates are increasing in some states", subtitle = str_c(Sys.Date() - months(1), " through ", max(my_data$as_of), "; Ordered by highest positive rate for the month")) +
  theme(legend.title = element_blank()) +
  facet_wrap(facets = vars(reorder(code, desc(month_pos))), nrow = 5) +
    theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x  = element_blank(),
        # strip.text.x = element_blank(),
        legend.position = 0)
```






```{r echo=FALSE}
test_growth %>%
  inner_join(code_names, by = "code") %>%
  inner_join(death_growth, by = "code") %>% 
  arrange(desc(tests_weekly_per_mil)) %>% 
  # filter(tests_weekly_per_mil < quantile(test_growth$tests_weekly_per_mil, probs = 0.5)) %>% 
  ggplot(mapping = aes(x = death_weekly_growth, y = tests_weekly_per_mil, label = code, fill = reg_2)) +
  geom_label_repel() +
  labs(x = "Growth in weekly deaths", y = "Weekly tests per million residents", title = stringr::str_c("State tests and weekly growth in deaths"), subtitle = str_c("week ending", death_growth$wk_ending[1], sep = " ")) +
  theme(legend.title=element_blank())
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
case_growth %>%
  inner_join(code_names) %>% 
  arrange(desc(cases_weekly_per_mil)) %>% 
  filter(cases_weekly_per_mil > quantile(case_growth$cases_weekly_per_mil, probs = 0.8) |
           cases_weekly_per_mil < quantile(case_growth$cases_weekly_per_mil, probs = 0.2)) %>% 
  ggplot() +
  geom_col(mapping = aes(x = reorder(code, X = desc(cases_weekly_per_mil)), y = cases_weekly_per_mil, fill = reg_2)) +
  labs(x = "state", y = "Weekly cases per million residents", title = stringr::str_c("States with most new cases per million"), subtitle = str_c("2 weeks ending", case_growth$wk_ending[1], sep = " ")) +
  theme(legend.title=element_blank())
```

```{r echo=FALSE, message=FALSE, warning=FALSE}


my_data %>% 
  inner_join(code_names) %>% 
  inner_join(st_pop_2019) %>%
  group_by(reg_2) %>% 
  filter(as_of > Sys.Date() - months(1)) %>%
  # wday(as_of) == wday(max(as_of)),
  ungroup() %>% 
  group_by(reg_2, as_of) %>% 
  summarize(case_sum = sum(case_ch) / sum(pop_2019) * 1000000) %>%
  ggplot() +
  geom_smooth(mapping = aes(x = as_of, y = case_sum, color = reg_2, fill = reg_2), alpha = .1) +
  labs(x = "Date", y = "New cases per million", title = "New cases drop sharply in the northeast while the south rises again", subtitle = str_c("Month ending ", case_growth$wk_ending[1])) +
  theme(legend.title=element_blank())
```


Adds 2016 presidential election results
```{r}
results_2016 <- read_csv("results_2016.csv")
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
my_data %>% 
  inner_join(code_names) %>% 
  inner_join(st_pop_2019) %>%
  inner_join(results_2016) %>% 
  filter(between(as_of, ymd(20200601), ymd(20200630))) %>% 
  group_by(code) %>% 
  mutate(case_growth = 100 * (cases - min(cases, na.rm = TRUE))/ min(cases, na.rm = TRUE),
         is_clinton = (t_mgn < 0),
         month_growth = max(case_growth, na.rm = TRUE)) %>%
  ungroup() %>% 
  ggplot() +
  geom_smooth(mapping = aes(x = as_of, y = case_growth, color = is_clinton), na.rm = TRUE, span = .1) +
  labs(x = "state", y = "Growth rate of COVID-19 cases", title = "Sun belt states saw the highest COVID-19 case growth rates in June", subtitle = "Growth rate of total COVID-19 cases from 1 to 30 June 2020 by state") +
  facet_wrap(facets = vars(reorder(code, desc(month_growth))), nrow = 5) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x  = element_blank(),
        strip.background = element_rect(fill = "lightgray"),
        legend.position = 0)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
max_ch <- merge(my_data, merge(st_pop_2019, code_names, all = FALSE), all = FALSE)[between(as_of, ymd(20200601), ymd(20200630)), c("case_ch", "pop_2019", "code", "as_of")] %>%
  .[,"case_ch_per_mil" := round(case_ch / pop_2019 * 1E6)] %>% 
  .[case_ch_per_mil == max(case_ch_per_mil),]

my_data %>% 
  inner_join(code_names) %>% 
  inner_join(st_pop_2019) %>%
  inner_join(results_2016) %>% 
  filter(between(as_of, ymd(20200601), ymd(20200630))) %>% 
  group_by(code) %>% 
  mutate(month_ch = (max(cases, na.rm = TRUE) - min(cases, na.rm = TRUE)) / pop_2019,
         is_clinton = (t_mgn < 0),
         case_sum = case_ch / pop_2019 * 1000000,
         y_label = if_else(lubridate::mday(as_of) == 7, case_sum + 50, NULL)) %>%
  ungroup() %>% 
  ggplot() +
  geom_smooth(mapping = aes(x = as_of, y = case_sum, color = is_clinton, fill = is_clinton), alpha = .1, na.rm = TRUE, span = .4) +
  geom_label(mapping = aes(x = as_of, y = y_label, label = code, color = is_clinton), na.rm = TRUE) +
  labs(x = "state", y = "New daily COVID-19 cases per million residents", title = "Sun belt states saw the most new COVID-19 cases in June", subtitle = "Data from 1 to 30 June 2020 by state in order of total new June cases", caption = str_c("Max new cases per million on one day was ", max_ch[,case_ch_per_mil], " on ", max_ch$as_of[1], " in ", max_ch[, "code"], ". Multiple states reported 0 new cases on various days")) +
  facet_wrap(facets = vars(reorder(code, desc(month_ch))), nrow = 7) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x  = element_blank(),
        strip.text.x = element_blank(),
        legend.position = 0)
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
my_data %>% 
  inner_join(code_names) %>% 
  inner_join(st_pop_2019) %>%
  group_by(reg_2) %>% 
  # filter(code %in% c("AZ", "FL", "SC", "AL", "MS", "CA", "MN", "NY", "GA", "TX")) %>% 
  filter(as_of > Sys.Date() - months(1)
         # ,reg_2 %in% c("Northeast", "South", "Southwest")
         ) %>%
  # wday(as_of) == wday(max(as_of)),
  ungroup() %>% 
  group_by(code, as_of) %>% 
  summarize(case_sum = sum(case_ch) / sum(pop_2019) * 1000000, reg_2 = min(reg_2)) %>%  
  mutate(reg_2 = factor(reg_2, levels = c("Middle South", "Midwest", "Northeast", "Plain and Mountain", "South", "Southwest", "West Coast"))) %>% 
  ggplot() +
  geom_smooth(mapping = aes(x = as_of, y = case_sum, color = reg_2), alpha = .1) +
  labs(x = "state", y = "New cases per million", title = "Do the appearance of new cases align with protests?", subtitle = str_c("Data from the month ending ", case_growth$wk_ending[1], " could offer clues", sep = " ")) +
  facet_wrap(facets = vars(reorder(code, reg_2)), nrow = 5) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x  = element_blank(),
        strip.background = element_rect(fill = "lightgray"),
        legend.title = element_blank())
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
case_growth %>%
  inner_join(code_names) %>% 
  arrange(desc(cases_weekly_growth)) %>% 
  filter(cases_weekly_growth > quantile(case_growth$cases_weekly_growth, probs = 0.7)) %>% 
  ggplot() +
  geom_col(mapping = aes(x = reorder(code, X = desc(cases_weekly_growth)), y = cases_weekly_growth, fill = reg_2)) +
  labs(x = "state", y = "weekly case growth rate", title = stringr::str_c("Highest case growth rate by state, week ending", case_growth$wk_ending[1], sep = " ")) +
  theme(legend.title=element_blank())
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
death_growth %>%
  inner_join(code_names) %>% 
  ggplot(mapping = aes(x = death_weekly_growth, y = death_weekly_per_mil, color = reg_2)) +
  ## geom_point() +
  ggrepel::geom_text_repel(mapping = aes(label = code)) +
  labs(x = "Weekly death growth rate", y = "Weekly deaths per million", title = "Deaths over the past week per million and growth in deaths",
       subtitle = "States having a hard time now and those who may face hard times soon") +
  theme(legend.title=element_blank())
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
case_growth %>%
  inner_join(code_names) %>% 
  ggplot(mapping = aes(x = cases_weekly_growth, y = cases_weekly_per_mil, color = reg_2)) +
  ## geom_point() +
  ggrepel::geom_text_repel(mapping = aes(label = code)) +
  labs(x = "Weekly case growth rate", y = "Weekly new cases per million", title = "Cases over the past week per million and growth in cases",
       subtitle = "Shows states having a hard time now and those who may face hard times soon") +
  theme(legend.title=element_blank())
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
pk <- c("AZ")


my_data %>% 
  filter(code %in% pk) %>%
    mutate(death_ch = if_else(as_of == ymd("2020-04-30") & code == "TX", 50, as.double(death_ch))) %>% 
  group_by(as_of) %>%
  summarize(us_cases = sum(cases, na.rm = TRUE),
            us_cases_ch = sum(case_ch, na.rm = TRUE),
            us_deaths = sum(death, na.rm = TRUE),
            us_deaths_ch = sum(death_ch, na.rm = TRUE)) %>% 
  filter(us_deaths > 9) %>% 
  mutate(since = min(as_of),
         is_day = if_else(weekdays(as_of) == weekdays(my_data[[1,1]]), 0.3, 0.1)) %>% 
  ggplot(mapping = aes(x = as_of, y = us_deaths_ch)) +
  geom_smooth(linetype = 0, mapping = aes(fill = weekdays(as_of), alpha = is_day)) +
  geom_smooth(size = 1, alpha = 0, linetype = 2, color = "black") +
  geom_vline(xintercept = ymd(20200526) + days(5)) +
  theme(legend.position = "none") +
  labs(title = str_c("Are", pk, "deaths plateauing or even dropping?", sep = " "), subtitle = str_c("Deaths per day since", min(my_data[code %in% pk, as_of]), sep = " "), x = NULL, y = "COVID-19 daily deaths") +
  scale_alpha(range = c(.1, .3))
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
pk <- c("OK")


my_data %>% 
  filter(code %in% pk) %>%
    mutate(case_ch = as.double(case_ch)) %>% 
  group_by(as_of) %>%
  summarize(us_cases = sum(cases, na.rm = TRUE),
            us_cases_ch = sum(case_ch, na.rm = TRUE),
            us_deaths = sum(death, na.rm = TRUE),
            us_deaths_ch = sum(death_ch, na.rm = TRUE)) %>% 
  filter(us_deaths > 199) %>% 
  mutate(since = min(as_of),
         is_day = if_else(weekdays(as_of) == weekdays(my_data[[1,1]]), 0.3, 0.1)) %>% 
  ggplot(mapping = aes(x = as_of, y = us_cases_ch)) +
  geom_smooth(linetype = 0, mapping = aes(fill = weekdays(as_of), alpha = is_day)) +
  geom_smooth(size = 1, alpha = 0, linetype = 1, color = "black", span = .5) +
  geom_vline(xintercept = ymd(20200621), color = "dodgerblue", linetype = 2) +
  # theme(legend.position = "none") +
  labs(title = str_c("It appears as though", pk, "cases are not plateauing, let alone dropping", sep = " "), subtitle = str_c("Cases per day since", min(my_data[death_ch > 9 & code == 'OK', as_of]), sep = " "), x = NULL, y = "New COVID-19 cases by day", caption = "The vertical, dashed blue line marks the President's 21 June rally in Tulsa") +
  scale_alpha(range = c(.1, .3))
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
pk <- c("")

my_data %>% 
  # filter(code %in% pk) %>%
  group_by(as_of, code) %>%
  summarize(us_cases = sum(cases, na.rm = TRUE),
            us_cases_ch = sum(case_ch, na.rm = TRUE),
            us_deaths = sum(death, na.rm = TRUE),
            us_deaths_ch = sum(death_ch, na.rm = TRUE)) %>% 
  inner_join(code_names) %>% 
  inner_join(st_pop_2019) %>% 
  filter(as_of > ymd(20200331)) %>%
  filter(reg_2 %in% c("South", "Midwest", "Northeast", "Southwest")) %>% 
  ggplot(mapping = aes(x = as_of, y = us_cases_ch/pop_2019 * 1000000)) +
  # geom_smooth(linetype = 0, mapping = aes(fill = weekdays(as_of)), alpha = 0.1) +
  geom_smooth(size = 1, linetype = 1, mapping = aes(color = reg_2, fill = reg_2), span = .5, alpha = .1) +
  geom_vline(xintercept = ymd("2020-05-22") + days(5), color = "red", linetype = 2) +
  geom_vline(xintercept = ymd("2020-05-29") + days(5), color = "blue", linetype = 2) +
  theme(legend.title = element_blank()) +
  labs(title = "After mid-May, cases fell in the North from Minnesota to Maine\nand rose sharply in sun belt states from Arizona to Florida", x = NULL, y = "New COVID-19 cases per million residents", caption = "Vertical red and blue lines mark five days after the start of\nMemorial Day weekend and national protests, respectively", subtitle = str_c("Data as of ", max(my_data$as_of)))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
pk <- c("NY")

my_data %>% 
  filter(code != pk) %>% 
  group_by(as_of) %>%
  summarize(us_cases = sum(cases, na.rm = TRUE),
            us_cases_ch = sum(case_ch, na.rm = TRUE),
            us_deaths = sum(death, na.rm = TRUE),
            us_deaths_ch = sum(death_ch, na.rm = TRUE)) %>% 
  filter(us_cases > 99) %>%
  mutate(since = min(as_of)) %>% 
  ggplot(mapping = aes(x = as_of, y = us_deaths_ch)) +
  geom_smooth(linetype = "dashed", color = "black") +
  geom_smooth(linetype = 0, mapping = aes(fill = weekdays(as_of)), alpha = 0.1) +
  labs(title = str_c("Are non-", pk, " deaths plateauing or even dropping?", sep = ""), subtitle = "U.S. deaths since the 100th case", x = "date", y = "COVID-19 deaths")
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
pk <- c("NY", "NJ", "MA", "MI", "CT", "RI", "CA")

my_data %>% 
  filter(!(code %in% (pk))) %>% 
  group_by(as_of) %>%
  summarize(us_cases = sum(cases, na.rm = TRUE),
            us_cases_ch = sum(case_ch, na.rm = TRUE),
            us_deaths = sum(death, na.rm = TRUE),
            us_deaths_ch = sum(death_ch, na.rm = TRUE)) %>% 
  filter(us_cases > 99) %>%
  mutate(since = min(as_of)) %>% 
  ggplot(mapping = aes(x = as_of, y = us_cases_ch)) +
  geom_smooth(linetype = 0, alpha = .2, mapping = aes(fill = weekdays(as_of))) +
  geom_smooth(alpha = 0, size = 1, linetype = 2, color = "black") +
  theme(legend.position = "none") +
  labs(title = str_c("Are non-", str_c(pk, collapse = ", "), " cases plateauing or even dropping?", sep = ""), subtitle = "Cases since the 100th case", x = "date", y = "COVID-19 new cases")
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
top_n(death_growth, n = 20) %>%
  inner_join(top_n(case_growth, n = 20)) %>%
  inner_join(code_names) %>% 
  filter((death_weekly_per_mil > as.numeric(reorder(death_growth$death_weekly_per_mil, desc(death_growth$death_weekly_per_mil))[[11]])) |
           (cases_weekly_per_mil > as.numeric(reorder(case_growth$cases_weekly_per_mil, desc(case_growth$cases_weekly_per_mil))[[11]]))) %>% 
  ggplot(mapping = aes(x = death_weekly_per_mil, y = cases_weekly_per_mil)) +
  geom_smooth(method = "lm", mapping = aes(color = NULL), linetype = "dotted", fill = 0.1, color = "lightgray") +
  ## geom_point(mapping = aes(color = reg_2), size = 2) +
  ggrepel::geom_text_repel(mapping = aes(label = code, color = reg_2)) +
  labs(x = "Weekly deaths per million", y = "Weekly new cases per million", title = "States dealing with a lot right now", subtitle = str_c("As of ", death_growth[[1, "wk_ending"]])) +
  theme(legend.title=element_blank())
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
death_growth %>%
  inner_join(case_growth) %>%
  inner_join(code_names) %>% 
  filter((death_weekly_growth > 0) |
           (cases_weekly_growth > 0)) %>% 
  ggplot(mapping = aes(x = death_weekly_growth, y = cases_weekly_growth, color = reg_2)) +
  ggrepel::geom_text_repel(mapping = aes(label = code)) +
  labs(x = "Weekly growth in deaths", y = "Weekly growth in cases", title = "States where the growth of deaths or new cases are rising", subtitle = str_c("As of ", death_growth[[1, "wk_ending"]])) +
  theme(legend.title=element_blank())
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
death_growth %>%
  inner_join(case_growth) %>%
  inner_join(code_names) %>% 
  filter((death_weekly_growth <= 0) |
           (cases_weekly_growth <= 0)) %>% 
  ggplot(mapping = aes(x = death_weekly_growth, y = cases_weekly_growth, color = reg_2)) +
  ggrepel::geom_text_repel(mapping = aes(label = code)) +
  labs(x = "Weekly growth in deaths", y = "Weekly growth in cases", title = "States where the growth of deaths or new cases are falling", subtitle = str_c("As of ", death_growth[[1, "wk_ending"]])) +
  theme(legend.title=element_blank())

po <- TRUE
```






```{r echo=FALSE, message=FALSE, warning=FALSE}
top_n(death_growth, n = 20) %>%
  inner_join(top_n(case_growth, n = 20)) %>%
  inner_join(code_names) %>% 
  filter((death_weekly_per_mil > as.numeric(reorder(death_growth$death_weekly_per_mil, desc(death_growth$death_weekly_per_mil))[[11]])) |
           (cases_weekly_per_mil > as.numeric(reorder(case_growth$cases_weekly_per_mil, desc(case_growth$cases_weekly_per_mil))[[11]]))) %>% 
  ggplot(mapping = aes(x = death_weekly_per_mil, y = cases_weekly_per_mil)) +
  geom_smooth(method = "lm", mapping = aes(color = NULL), linetype = "dotted", fill = 0.1, color = "lightgray") +
  ## geom_point(mapping = aes(color = reg_2), size = 2) +
  ggrepel::geom_text_repel(mapping = aes(label = code, color = reg_2)) +
  labs(x = "Weekly deaths per million", y = "Weekly new cases per million", title = "States dealing with a lot right now") +
  theme(legend.title=element_blank())
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
since_100 <- my_data %>% 
  arrange(code, as_of) %>% 
  inner_join(code_names) %>% 
  inner_join(st_pop_2019) %>% 
  mutate(cases_pm = cases / pop_2019 * 1E6,
         deaths_pm = death / pop_2019 * 1E6) %>% 
  filter(cases_pm >= 100) %>% 
  group_by(code) %>% 
  mutate(days_in = as.integer(as_of - min(as_of))) %>% 
  ungroup()
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
since_100_labels <- since_100 %>% 
  group_by(code) %>% 
  summarize(lab_days = max(days_in), lab_deaths = max(deaths_pm))

test_code <- c("MN", "TX", "AZ", "CA", "FL", "OK", "MN", "NY")

since_100 %>%
  filter(code %in% test_code) %>%
  inner_join(since_100_labels) %>%
  group_by(code) %>% 
  mutate(lab_days = if_else(lab_days == days_in, lab_days, NULL),
         lab_deaths = if_else(lab_deaths == deaths_pm, lab_deaths, NULL)) %>%
  ggplot(mapping = aes(color = code, x = days_in, y = deaths_pm)) +
  geom_line() +
  geom_label_repel(aes(x = lab_days, y = lab_deaths, label = code), na.rm = TRUE) +
  labs(x = "Days since a state identified COVID-19 in 0.01% of its residents",
       y = "Cumulative deaths per million residents",
       title = "Allows for comparison between states on different timelines") +
  theme(legend.title=element_blank())
  

```



```{r echo=FALSE, message=FALSE, warning=FALSE}
since_100 %>% 
  inner_join(since_100_labels) %>% 
  mutate(cfr = death / cases,
         tests_pm = tests / pop_2019 * 1E6) %>% 
  filter(days_in == 21) %>% 
  ggplot(mapping = aes(x = tests_pm, y = cfr, label = code)) +
  geom_smooth(method = "lm") +
  geom_text_repel(mapping = aes(color = reg_2)) +
  labs(x = "Coronavirus tests per million residents", y = "Case fatality ratio", title = "Testing more is associated with a lower case fatality rate") +
  theme(legend.title=element_blank())
  
```

```{r}

```

